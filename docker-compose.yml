services:
  trouttv:
    # Option 1: Use Docker Hub image (change yourusername)
    # image: yourusername/trouttv:latest

    # Option 2: Use GitHub Container Registry
    # image: ghcr.io/yourusername/trouttv:latest

    # Option 3: Use local image (must build first: docker build -t trouttv:latest .)
    image: trouttv:latest
    container_name: trouttv
    hostname: trouttv

    ports:
      # Change the first port (8000) to expose on different host port if needed
      # Examples: "8080:8000" or "9000:8000"
      - "8000:8000"

    volumes:
      # Named volumes - managed by Docker, persists data
      - trouttv_channels:/data/channels
      - trouttv_logos:/data/logos
      - trouttv_streams:/streams

      # Bind mount - point to your media directory on host
      # IMPORTANT: Change this path to your actual media location!
      # Windows example: - D:/Media:/data/media
      # Linux example: - /mnt/media:/data/media
      - /data/media:/data/media

    environment:
      # Server Configuration
      - HOST=0.0.0.0
      - PORT=8000

      # IMPORTANT: Change this to your server's IP address or domain
      # Examples:
      #   - BASE_URL=http://192.168.1.100:8000
      #   - BASE_URL=http://trouttv.yourdomain.com:8000
      - BASE_URL=http://localhost:8000

      # Directory paths (container paths - don't change unless you know what you're doing)
      - CHANNELS_DIR=/data/channels
      - MEDIA_DIR=/data/media
      - STREAMS_DIR=/streams

      # Stream settings
      - STREAM_TIMEOUT=60          # Seconds before stopping idle streams
      - CLEANUP_INTERVAL=30        # Seconds between cleanup checks
      - EPG_DAYS_AHEAD=2           # Days of EPG to generate

      # FFmpeg paths (usually auto-detected)
      - FFMPEG_PATH=ffmpeg
      - FFPROBE_PATH=ffprobe

    # Intel QSV Hardware Acceleration
    # Exposes the Intel GPU to the container for hardware transcoding
    devices:
      - /dev/dri:/dev/dri

    # Add video group for GPU access (adjust GID if needed)
    # Run 'getent group video' or 'getent group render' on host to find correct GID
    group_add:
      - "44"    # Common video group GID (may need to change based on your system)
      - "109"   # Common render group GID (may need to change based on your system)

    restart: unless-stopped

    # Health check to monitor container status
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Labels for organization in Portainer
    labels:
      - "com.trouttv.description=IPTV Streaming Server"
      - "com.trouttv.version=1.0.0"
      - "traefik.enable=false"  # Set to true if using Traefik reverse proxy

# Named volumes for persistent data
volumes:
  trouttv_channels:
    driver: local
    labels:
      - "com.trouttv.description=Channel configuration files"

  trouttv_logos:
    driver: local
    labels:
      - "com.trouttv.description=Uploaded channel logos"

  trouttv_streams:
    driver: local
    labels:
      - "com.trouttv.description=Temporary HLS stream segments"

# Optional: Create a custom network
# Uncomment if you want to connect to other containers (e.g., reverse proxy)
# networks:
#   trouttv_network:
#     driver: bridge
